{% extends 'base.html' %}

{% block title %}
  ダッシュボード
{% endblock %}
{% block h1 %}
  ダッシュボード
{% endblock %}

{% block content %}
  <div class="row">
    <!-- 統計カード -->
    <div class="col-md-4 mb-4">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-book fa-3x text-primary mb-3"></i>
          <h2 class="card-title">{{ total_books }}</h2>
          <p class="card-text">登録書籍数</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-4">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-comments fa-3x text-success mb-3"></i>
          <h2 class="card-title">{{ total_reviews }}</h2>
          <p class="card-text">投稿レビュー数</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-4">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-heart fa-3x text-danger mb-3"></i>
          <h2 class="card-title">{{ favorite_books|length }}</h2>
          <p class="card-text">お気に入り書籍数</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- カテゴリ別統計 -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>カテゴリ別統計</h5>
        </div>
        <div class="card-body">
          {% for category_name, count in category_stats.items %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span>{{ category_name }}</span>
              <div class="d-flex align-items-center">
                <div class="progress me-2" style="width: 100px;">
                  <div class="progress-bar" role="progressbar" 
                       style="width: {% if total_books > 0 %}{{ count|floatformat:0 }}{% else %}0{% endif %}%">
                  </div>
                </div>
                <span class="badge bg-primary">{{ count }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- 最近のアクティビティ -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-clock me-2"></i>最近のアクティビティ</h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            {% for book in recent_books %}
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  <i class="fas fa-book text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1 book-title">{{ book.title }}</h6>
                  <small class="text-muted">{{ book.created_at|date:"Y年m月d日" }}</small>
                </div>
                <a href="{% url 'detail-book' book.id %}" class="btn btn-sm btn-outline-primary">
                  詳細
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- お気に入り書籍 -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-heart me-2"></i>お気に入り書籍</h5>
        </div>
        <div class="card-body">
          {% if favorite_books %}
            {% for book in favorite_books %}
              <div class="d-flex align-items-center mb-3">
                {% if book.thumbnail %}
                  <img src="{{ book.thumbnail.url }}" class="rounded me-3" style="width: 50px; height: 70px; object-fit: cover;">
                {% else %}
                  <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 70px;">
                    <i class="fas fa-book text-muted"></i>
                  </div>
                {% endif %}
                <div class="flex-grow-1">
                  <h6 class="mb-1 book-title">{{ book.title }}</h6>
                  <div class="rating-stars small">
                    {% for i in "12345" %}
                      {% if forloop.counter <= book.get_average_rating %}
                        <i class="fas fa-star"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                    <small class="text-muted ms-1">({{ book.get_average_rating|floatformat:1 }})</small>
                  </div>
                </div>
                <a href="{% url 'detail-book' book.id %}" class="btn btn-sm btn-outline-primary">
                  詳細
                </a>
              </div>
            {% endfor %}
            <div class="text-center mt-3">
              <a href="{% url 'favorite-books' %}" class="btn btn-primary">
                すべてのお気に入りを見る
              </a>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-heart-broken fa-3x text-muted mb-3"></i>
              <h6 class="text-muted">お気に入り書籍がありません</h6>
              <p class="text-muted">書籍一覧からお気に入りを登録してみましょう</p>
              <a href="{% url 'list-book' %}" class="btn btn-primary">
                書籍一覧へ
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- 最近のレビュー -->
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-comments me-2"></i>最近のレビュー</h5>
        </div>
        <div class="card-body">
          {% if recent_reviews %}
            {% for review in recent_reviews %}
              <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-1">{{ review.title }}</h6>
                  <div class="rating-stars small">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rate %}
                        <i class="fas fa-star"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
                <p class="text-muted small mb-2">{{ review.text|truncatechars:100 }}</p>
                <small class="text-muted">
                  <i class="fas fa-book me-1"></i>{{ review.book.title }} | 
                  <i class="fas fa-calendar me-1"></i>{{ review.created_at|date:"Y年m月d日" }}
                </small>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
              <h6 class="text-muted">レビューがありません</h6>
              <p class="text-muted">書籍にレビューを投稿してみましょう</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- クイックアクション -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>クイックアクション</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <a href="{% url 'create-book' %}" class="btn btn-primary w-100">
                <i class="fas fa-plus me-2"></i>書籍を登録
              </a>
            </div>
            <div class="col-md-3 mb-3">
              <a href="{% url 'list-book' %}" class="btn btn-outline-primary w-100">
                <i class="fas fa-list me-2"></i>書籍一覧
              </a>
            </div>
            <div class="col-md-3 mb-3">
              <a href="{% url 'favorite-books' %}" class="btn btn-outline-danger w-100">
                <i class="fas fa-heart me-2"></i>お気に入り
              </a>
            </div>
            <div class="col-md-3 mb-3">
              <a href="{% url 'list-book' %}" class="btn btn-outline-success w-100">
                <i class="fas fa-search me-2"></i>書籍を探す
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %} 